version: '3.8'

services:
  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/yourusername/echochat/backend:latest}
    container_name: echochat-backend-prod
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      # Application settings
      - TARGET_URL=${TARGET_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-5-20250929}

      # Scraping configuration
      - SCRAPE_FREQUENCY_HOURS=${SCRAPE_FREQUENCY_HOURS:-24}
      - MAX_CONCURRENT_PAGES=${MAX_CONCURRENT_PAGES:-5}
      - SCRAPER_TIMEOUT=${SCRAPER_TIMEOUT:-30000}
      - RESPECT_ROBOTS_TXT=${RESPECT_ROBOTS_TXT:-false}

      # Database & storage
      - DATABASE_URL=sqlite:///./data/echochat.db
      - CHROMA_PERSIST_DIRECTORY=./chroma_data

      # RAG configuration
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - CHUNK_SIZE=${CHUNK_SIZE:-1000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - TOP_K_RESULTS=${TOP_K_RESULTS:-5}

      # Server configuration
      - HOST=0.0.0.0
      - PORT=8000
      - CORS_ORIGINS=${CORS_ORIGINS:-*}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=./logs/app.log
      - LOG_FORMAT=json
      - LOG_ROTATION=daily
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-30}

    volumes:
      - backend-data:/app/data
      - backend-logs:/app/logs
      - chroma-data:/app/chroma_data

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    labels:
      - "service=echochat-backend"
      - "environment=production"

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/yourusername/echochat/frontend:latest}
    container_name: echochat-frontend-prod
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NODE_ENV=production

    depends_on:
      backend:
        condition: service_healthy

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    labels:
      - "service=echochat-frontend"
      - "environment=production"

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  chromadb:
    image: chromadb/chroma:latest
    container_name: echochat-chromadb-prod
    ports:
      - "${CHROMADB_PORT:-8001}:8000"
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=${CHROMA_TELEMETRY:-false}
    volumes:
      - chroma-data:/chroma/chroma
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

    labels:
      - "service=echochat-chromadb"
      - "environment=production"

  scheduler:
    image: ${BACKEND_IMAGE:-ghcr.io/yourusername/echochat/backend:latest}
    container_name: echochat-scheduler-prod
    command: ["python", "-m", "app.scheduler.scheduler"]
    environment:
      # Same as backend
      - TARGET_URL=${TARGET_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SCRAPE_FREQUENCY_HOURS=${SCRAPE_FREQUENCY_HOURS:-24}
      - DATABASE_URL=sqlite:///./data/echochat.db
      - CHROMA_PERSIST_DIRECTORY=./chroma_data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=./logs/scheduler.log

    volumes:
      - backend-data:/app/data
      - backend-logs:/app/logs
      - chroma-data:/app/chroma_data

    depends_on:
      backend:
        condition: service_healthy

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

    labels:
      - "service=echochat-scheduler"
      - "environment=production"

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

volumes:
  backend-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BACKEND_DATA_PATH:-./data/backend}

  backend-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BACKEND_LOGS_PATH:-./data/logs}

  chroma-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CHROMA_DATA_PATH:-./data/chroma}

networks:
  default:
    name: echochat-production
    driver: bridge

# Production deployment notes:
#
# 1. Create required directories before starting:
#    mkdir -p ./data/{backend,logs,chroma}
#
# 2. Set environment variables in .env.production file
#
# 3. Pull images from GHCR:
#    docker compose -f docker-compose.production.yml pull
#
# 4. Start services:
#    docker compose -f docker-compose.production.yml up -d
#
# 5. Monitor logs:
#    docker compose -f docker-compose.production.yml logs -f
#
# 6. Health checks:
#    docker compose -f docker-compose.production.yml ps
#
# 7. Update deployment:
#    docker compose -f docker-compose.production.yml pull
#    docker compose -f docker-compose.production.yml up -d --force-recreate
#
# 8. Backup data:
#    tar -czf backup-$(date +%Y%m%d).tar.gz ./data/
